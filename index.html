<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Dog Training Progress Tracker">
    <title>Dog Training Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Utility functions for localStorage
        const storage = {
            getWorkouts: () => JSON.parse(localStorage.getItem('workouts') || '[]'),
            saveWorkouts: (workouts) => localStorage.setItem('workouts', JSON.stringify(workouts)),
            getWorkout: (id) => storage.getWorkouts().find(w => w.id === id),
            updateWorkout: (id, updates) => {
                const workouts = storage.getWorkouts();
                const index = workouts.findIndex(w => w.id === id);
                if (index !== -1) {
                    workouts[index] = { ...workouts[index], ...updates };
                    storage.saveWorkouts(workouts);
                }
            },
            getTaskSets: () => JSON.parse(localStorage.getItem('taskSets') || '{}'),
            saveTaskSet: (name, data) => {
                const taskSets = storage.getTaskSets();
                taskSets[name] = data;
                localStorage.setItem('taskSets', JSON.stringify(taskSets));
            }
        };

        // Calculate duration steps with dog-friendly increments
        const calculateDurationSteps = (startDuration, endDuration) => {
            const steps = [];
            let currentDuration = startDuration;

            while (currentDuration < endDuration) {
                steps.push(currentDuration);

                // Calculate next increment based on current duration
                let increment;
                if (currentDuration < 60) {
                    increment = Math.round(currentDuration * 0.6);
                } else if (currentDuration < 300) {
                    increment = Math.round(currentDuration * 0.50 / 30) * 30;
                } else if (currentDuration < 1200) {
                    increment = Math.round(currentDuration * 0.25 / 60) * 60;
                } else {
                    increment = Math.round(currentDuration * 0.10 / 60) * 60;
                }

                // Ensure at least 1 second increment
                increment = Math.max(increment, 1);
                currentDuration += increment;
            }

            // Add the final target duration
            steps.push(endDuration);

            return steps;
        };

        // Calculate required successes based on duration
        const getRequiredSuccesses = (currentDuration) => {
            if (currentDuration < 60) {
                return 8;
            } else if (currentDuration < 300) {
                return 5;
            } else if (currentDuration < 1200) {
                return 2;
            } else {
                return 1;
            }
        };

        // Generate random duration from normal distribution
        const normalRandom = (mean, sigma) => {
            // Box-Muller transform to generate normal distribution
            const u1 = Math.random();
            const u2 = Math.random();
            const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            const sample = mean + sigma * z0;
            // Ensure positive duration and round to 1 decimal place
            return Math.max(0.1, Math.round(sample * 10) / 10);
        };

        // Load task sets from JSON (for demo, would normally use fetch)
        const loadTaskSetFromJSON = async (filename) => {
            try {
                const response = await fetch(`task_sets/${filename}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                storage.saveTaskSet(filename, data);
                return data;
            } catch (error) {
                console.error('Error loading task set:', error);
                return null;
            }
        };

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('main');
            const [selectedWorkoutId, setSelectedWorkoutId] = useState(null);

            const navigate = (page, workoutId = null) => {
                setCurrentPage(page);
                setSelectedWorkoutId(workoutId);
            };

            return (
                <div className="min-h-screen pb-20">
                    {currentPage === 'main' && <MainPage navigate={navigate} />}
                    {currentPage === 'choose-workout-type' && <ChooseWorkoutTypePage navigate={navigate} />}
                    {currentPage === 'new-workout' && <NewWorkoutPage navigate={navigate} />}
                    {currentPage === 'new-taskset-workout' && <NewTaskSetWorkoutPage navigate={navigate} />}
                    {currentPage === 'workout' && <WorkoutPage navigate={navigate} workoutId={selectedWorkoutId} />}
                    {currentPage === 'training' && <TrainingPage navigate={navigate} workoutId={selectedWorkoutId} />}
                </div>
            );
        }

        // Main Page Component
        function MainPage({ navigate }) {
            const [workouts, setWorkouts] = useState(storage.getWorkouts());

            const deleteWorkout = (id) => {
                if (confirm('Are you sure you want to delete this workout?')) {
                    const updatedWorkouts = workouts.filter(w => w.id !== id);
                    storage.saveWorkouts(updatedWorkouts);
                    setWorkouts(updatedWorkouts);
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6 mb-4">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">üêï Dog Training Tracker</h1>
                        <p className="text-gray-600">Track your training progress</p>
                    </div>

                    <button
                        onClick={() => navigate('choose-workout-type')}
                        className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold mb-6 shadow-md hover:bg-blue-700 transition"
                    >
                        + Create New Workout
                    </button>

                    <div className="space-y-3">
                        {workouts.length === 0 ? (
                            <div className="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
                                No workouts yet. Create your first one!
                            </div>
                        ) : (
                            workouts.map(workout => (
                                <div key={workout.id} className="bg-white rounded-lg shadow-md p-4 flex items-center justify-between">
                                    <div
                                        className="flex-1 cursor-pointer"
                                        onClick={() => navigate('training', workout.id)}
                                    >
                                        <h3 className="text-lg font-semibold text-gray-800">{workout.name}</h3>
                                        <p className="text-sm text-gray-600">
                                            Level {workout.currentLevel + 1} / {workout.totalLevels}
                                        </p>
                                    </div>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            deleteWorkout(workout.id);
                                        }}
                                        className="ml-4 text-red-600 hover:text-red-800 font-semibold px-3 py-1"
                                    >
                                        Delete
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // Choose Workout Type Page Component
        function ChooseWorkoutTypePage({ navigate }) {
            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex items-center mb-6">
                            <button
                                onClick={() => navigate('main')}
                                className="text-blue-600 font-semibold mr-4"
                            >
                                ‚Üê Back
                            </button>
                            <h1 className="text-2xl font-bold text-gray-800">Choose Workout Type</h1>
                        </div>

                        <div className="space-y-4">
                            <button
                                onClick={() => navigate('new-workout')}
                                className="w-full bg-blue-50 hover:bg-blue-100 border-2 border-blue-600 text-left p-6 rounded-lg transition"
                            >
                                <h3 className="text-xl font-bold text-blue-800 mb-2">Duration-Based Workout</h3>
                                <p className="text-gray-600">Progressive duration training with automatic level increments</p>
                            </button>

                            <button
                                onClick={() => navigate('new-taskset-workout')}
                                className="w-full bg-green-50 hover:bg-green-100 border-2 border-green-600 text-left p-6 rounded-lg transition"
                            >
                                <h3 className="text-xl font-bold text-green-800 mb-2">Task Set Workout</h3>
                                <p className="text-gray-600">Protocol-based training with specific tasks to complete</p>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // New Task Set Workout Page Component
        function NewTaskSetWorkoutPage({ navigate }) {
            const [selectedTaskSet, setSelectedTaskSet] = useState(null);
            const [taskSetData, setTaskSetData] = useState(null);
            const [availableTaskSets, setAvailableTaskSets] = useState(['relaxation']);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const loadTaskSet = async (filename) => {
                setLoading(true);
                setError(null);
                try {
                    const data = await loadTaskSetFromJSON(filename);
                    if (data) {
                        setTaskSetData(data);
                        setSelectedTaskSet(filename);
                    } else {
                        setError('Failed to load task set. Make sure the file exists.');
                    }
                } catch (err) {
                    setError('Error loading task set: ' + err.message);
                    console.error('Load error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const createWorkout = () => {
                if (!taskSetData) {
                    alert('Please select a task set');
                    return;
                }

                const newWorkout = {
                    id: Date.now().toString(),
                    name: taskSetData.protocol,
                    type: 'taskset',
                    taskSetName: selectedTaskSet,
                    taskSets: taskSetData.task_sets,
                    totalLevels: taskSetData.task_sets.length,
                    currentLevel: 0,
                    currentTaskIndex: 0,
                    attempts: [],
                    createdAt: new Date().toISOString()
                };

                const workouts = storage.getWorkouts();
                workouts.push(newWorkout);
                storage.saveWorkouts(workouts);

                navigate('main');
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex items-center mb-6">
                            <button
                                onClick={() => navigate('choose-workout-type')}
                                className="text-blue-600 font-semibold mr-4"
                            >
                                ‚Üê Back
                            </button>
                            <h1 className="text-2xl font-bold text-gray-800">Create Task Set Workout</h1>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Select Task Set
                                </label>
                                <div className="space-y-2">
                                    {availableTaskSets.map(taskSetName => (
                                        <button
                                            key={taskSetName}
                                            onClick={() => loadTaskSet(taskSetName)}
                                            disabled={loading}
                                            className={`w-full text-left p-4 rounded-lg border-2 transition ${
                                                selectedTaskSet === taskSetName
                                                    ? 'border-green-600 bg-green-50'
                                                    : 'border-gray-300 hover:border-green-400 bg-white'
                                            } ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            <h3 className="font-semibold text-gray-800 capitalize">
                                                {taskSetName} {loading && selectedTaskSet === taskSetName ? '(Loading...)' : ''}
                                            </h3>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {error && (
                                <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                                    <p className="text-sm text-red-700">{error}</p>
                                </div>
                            )}

                            {taskSetData && (
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">Protocol Details</h3>
                                    <p className="text-sm text-gray-700 mb-2">{taskSetData.protocol}</p>
                                    <p className="text-sm text-gray-700">
                                        <span className="font-semibold">{taskSetData.task_sets.length}</span> sets with{' '}
                                        <span className="font-semibold">
                                            {taskSetData.task_sets.reduce((sum, set) => sum + set.tasks.length, 0)}
                                        </span>{' '}
                                        total tasks
                                    </p>
                                </div>
                            )}

                            <button
                                onClick={createWorkout}
                                disabled={!taskSetData || loading}
                                className={`w-full py-3 rounded-lg font-semibold shadow-md transition mt-6 ${
                                    taskSetData && !loading
                                        ? 'bg-green-600 text-white hover:bg-green-700 cursor-pointer'
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                            >
                                Create Workout
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // New Workout Page Component
        function NewWorkoutPage({ navigate }) {
            const [name, setName] = useState('');
            const [startDuration, setStartDuration] = useState(5);
            const [endDuration, setEndDuration] = useState(60);

            // Calculate number of levels based on the progressive increment algorithm
            const durationSteps = calculateDurationSteps(startDuration, endDuration);
            const numLevels = durationSteps.length;

            const createWorkout = () => {
                if (!name.trim()) {
                    alert('Please enter a workout name');
                    return;
                }

                if (startDuration >= endDuration) {
                    alert('Start duration must be less than end duration');
                    return;
                }
                
                const newWorkout = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    totalLevels: numLevels,
                    durationSteps,
                    attempts: [],
                    currentLevel: 0,
                    requiredSuccesses: getRequiredSuccesses(startDuration),
                    createdAt: new Date().toISOString()
                };

                const workouts = storage.getWorkouts();
                workouts.push(newWorkout);
                storage.saveWorkouts(workouts);
                
                navigate('main');
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex items-center mb-6">
                            <button
                                onClick={() => navigate('main')}
                                className="text-blue-600 font-semibold mr-4"
                            >
                                ‚Üê Back
                            </button>
                            <h1 className="text-2xl font-bold text-gray-800">Create New Workout</h1>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Workout Name
                                </label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    placeholder="e.g., Stay Command Training"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Start Duration (seconds)
                                </label>
                                <div className="flex items-center gap-3 mb-2">
                                    <button
                                        type="button"
                                        onClick={() => setStartDuration(Math.max(1, startDuration - 1))}
                                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                    >
                                        -
                                    </button>
                                    <input
                                        type="number"
                                        min="1"
                                        max="60"
                                        value={startDuration}
                                        onChange={(e) => {
                                            const val = parseInt(e.target.value) || 1;
                                            setStartDuration(Math.min(60, Math.max(1, val)));
                                        }}
                                        className="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setStartDuration(Math.min(60, startDuration + 1))}
                                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                    >
                                        +
                                    </button>
                                    <span className="text-gray-600 text-sm">seconds</span>
                                </div>
                                <input
                                    type="range"
                                    min="1"
                                    max="60"
                                    value={startDuration}
                                    onChange={(e) => setStartDuration(parseInt(e.target.value))}
                                    className="w-full"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    End Duration
                                </label>
                                <div className="flex items-center gap-3 mb-2">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            const decrement = endDuration <= 60 ? 1 : endDuration <= 300 ? 5 : endDuration <= 1200 ? 30 : 60;
                                            setEndDuration(Math.max(10, endDuration - decrement));
                                        }}
                                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                    >
                                        -
                                    </button>
                                    <input
                                        type="number"
                                        min="10"
                                        max="7200"
                                        value={endDuration}
                                        onChange={(e) => {
                                            const val = parseInt(e.target.value) || 10;
                                            setEndDuration(Math.min(7200, Math.max(10, val)));
                                        }}
                                        className="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => {
                                            const increment = endDuration < 60 ? 1 : endDuration < 300 ? 5 : endDuration < 1200 ? 30 : 60;
                                            setEndDuration(Math.min(7200, endDuration + increment));
                                        }}
                                        className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                    >
                                        +
                                    </button>
                                    <span className="text-gray-600 text-sm">
                                        {endDuration >= 60 ? `(${Math.floor(endDuration / 60)}m ${endDuration % 60}s)` : 'seconds'}
                                    </span>
                                </div>
                                <input
                                    type="range"
                                    min="0"
                                    max="1000"
                                    value={(() => {
                                        // Non-linear scaling: convert endDuration to slider position
                                        if (endDuration <= 60) return endDuration * 4; // 0-240: maps 10-60s (gives more precision)
                                        if (endDuration <= 300) return 240 + (endDuration - 60) * 1.5; // 240-600: maps 60-300s
                                        if (endDuration <= 1200) return 600 + (endDuration - 300) / 3; // 600-900: maps 300-1200s
                                        return 900 + (endDuration - 1200) / 60; // 900-1000: maps 1200-7200s
                                    })()}
                                    onChange={(e) => {
                                        const sliderVal = parseInt(e.target.value);
                                        let duration;
                                        if (sliderVal <= 240) duration = Math.round(sliderVal / 4);
                                        else if (sliderVal <= 600) duration = Math.round(60 + (sliderVal - 240) / 1.5);
                                        else if (sliderVal <= 900) duration = Math.round(300 + (sliderVal - 600) * 3);
                                        else duration = Math.round(1200 + (sliderVal - 900) * 60);
                                        setEndDuration(Math.min(7200, Math.max(10, duration)));
                                    }}
                                    className="w-full"
                                />
                            </div>

                            <div className="bg-blue-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-700 mb-2">
                                    Duration will increase from <span className="font-semibold">{startDuration}s</span> to{' '}
                                    <span className="font-semibold">{endDuration >= 60 ? `${Math.floor(endDuration / 60)}m ${endDuration % 60}s` : `${endDuration}s`}</span>
                                </p>
                                <p className="text-sm text-gray-700">
                                    This will create <span className="font-semibold">{numLevels}</span> levels with dog-friendly progressive increments
                                </p>
                            </div>

                            <button
                                onClick={createWorkout}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition mt-6"
                            >
                                Create Workout
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Workout Page Component
        function WorkoutPage({ navigate, workoutId }) {
            const [workout, setWorkout] = useState(storage.getWorkout(workoutId));

            if (!workout) {
                return (
                    <div className="max-w-2xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <p className="text-red-600">Workout not found</p>
                            <button
                                onClick={() => navigate('main')}
                                className="mt-4 text-blue-600 font-semibold"
                            >
                                ‚Üê Back to Main
                            </button>
                        </div>
                    </div>
                );
            }

            const isTaskSetWorkout = workout.type === 'taskset';
            const currentDuration = !isTaskSetWorkout
                ? (workout.durationSteps[workout.currentLevel] || workout.durationSteps[workout.durationSteps.length - 1])
                : 0;

            // Task-set workout details page
            if (isTaskSetWorkout) {
                const currentSet = workout.taskSets[workout.currentLevel];
                const totalTasksInSet = currentSet ? currentSet.tasks.length : 0;
                const completedTasksInSet = workout.currentTaskIndex;

                return (
                    <div className="max-w-2xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-md p-6 mb-4">
                            <div className="flex items-center mb-4">
                                <button
                                    onClick={() => navigate('training', workoutId)}
                                    className="text-blue-600 font-semibold mr-4"
                                >
                                    ‚Üê Back to Training
                                </button>
                                <h1 className="text-2xl font-bold text-gray-800">{workout.name}</h1>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <p className="text-sm text-gray-600">Current Set</p>
                                    <p className="text-2xl font-bold text-green-600">{workout.currentLevel + 1}/{workout.totalLevels}</p>
                                </div>
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <p className="text-sm text-gray-600">Tasks in Set</p>
                                    <p className="text-2xl font-bold text-blue-600">{completedTasksInSet}/{totalTasksInSet}</p>
                                </div>
                            </div>
                        </div>

                        {workout.attempts && workout.attempts.length > 0 && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-4">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Past Attempts</h2>
                                <div className="space-y-2">
                                    {workout.attempts.slice().reverse().map((attempt, index) => (
                                        <div key={index} className="border-b border-gray-200 pb-2">
                                            <div className="flex justify-between items-center">
                                                <div className="flex-1">
                                                    <div className="text-sm text-gray-600">
                                                        {new Date(attempt.completedAt).toLocaleDateString()} {new Date(attempt.completedAt).toLocaleTimeString()}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        Set {attempt.level + 1}, Task {attempt.taskIndex + 1}
                                                    </div>
                                                    <div className="text-sm text-gray-700 mt-1">
                                                        {attempt.task}
                                                    </div>
                                                </div>
                                                <span className={`text-sm font-semibold ${
                                                    attempt.result === 'success' ? 'text-green-600' : 'text-yellow-600'
                                                }`}>
                                                    {attempt.result === 'success' ? '‚úì' : '~'}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Upcoming Tasks</h2>
                            {currentSet && (
                                <div className="space-y-2">
                                    {currentSet.tasks.slice(workout.currentTaskIndex, workout.currentTaskIndex + 5).map((task, index) => (
                                        <div key={index} className="border-b border-gray-200 pb-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm text-gray-700">
                                                    {task.task}
                                                </span>
                                                {task.duration && (
                                                    <span className="text-xs font-semibold text-green-600">
                                                        {task.duration}s
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Duration-based workout details page
            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6 mb-4">
                        <div className="flex items-center mb-4">
                            <button
                                onClick={() => navigate('training', workoutId)}
                                className="text-blue-600 font-semibold mr-4"
                            >
                                ‚Üê Back to Training
                            </button>
                            <h1 className="text-2xl font-bold text-gray-800">{workout.name}</h1>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-600">Current Level</p>
                                <p className="text-2xl font-bold text-blue-600">{workout.currentLevel + 1}/{workout.totalLevels}</p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-lg">
                                <p className="text-sm text-gray-600">Level Duration</p>
                                <p className="text-2xl font-bold text-green-600">{currentDuration}s</p>
                            </div>
                        </div>
                    </div>

                    {workout.attempts && workout.attempts.length > 0 && (
                        <div className="bg-white rounded-lg shadow-md p-6 mb-4">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Past Attempts</h2>
                            <div className="space-y-2">
                                {workout.attempts.slice().reverse().map((attempt, index) => (
                                    <div key={index} className="border-b border-gray-200 pb-2">
                                        <div className="flex justify-between items-center">
                                            <div className="flex-1">
                                                <div className="text-sm text-gray-600">
                                                    {new Date(attempt.completedAt).toLocaleDateString()} {new Date(attempt.completedAt).toLocaleTimeString()}
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                    Level {attempt.level + 1} - Target: {attempt.duration}s
                                                    {attempt.actualDuration && ` | Actual: ${attempt.actualDuration}s`}
                                                </div>
                                            </div>
                                            <span className={`text-sm font-semibold ${
                                                attempt.result === 'success' ? 'text-green-600' :
                                                attempt.result === 'failure' ? 'text-yellow-600' : 'text-red-600'
                                            }`}>
                                                {attempt.result === 'success' ? '‚úì' : attempt.result === 'failure' ? '~' : '‚úó'}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Upcoming Levels</h2>
                        <div className="space-y-2">
                            {workout.durationSteps.slice(workout.currentLevel, workout.currentLevel + 5).map((duration, index) => (
                                <div key={index} className="border-b border-gray-200 pb-2">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm text-gray-600">
                                            Level {workout.currentLevel + index + 1}
                                        </span>
                                        <span className="text-sm font-semibold text-blue-600">
                                            {duration}s
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Training Page Component
        function TrainingPage({ navigate, workoutId }) {
            const [workout, setWorkout] = useState(storage.getWorkout(workoutId));
            const [timerState, setTimerState] = useState('ready');
            const [timeRemaining, setTimeRemaining] = useState(0);
            const [intervalId, setIntervalId] = useState(null);

            // Check if this is a task-set workout
            const isTaskSetWorkout = workout && workout.type === 'taskset';

            // Calculate consecutive successes from stored attempts
            const calculateConsecutiveSuccesses = (workout) => {
                if (!workout || !workout.attempts || workout.attempts.length === 0) {
                    return 0;
                }

                // Get attempts for the current level
                const currentLevelAttempts = workout.attempts.filter(a => a.level === workout.currentLevel);

                if (currentLevelAttempts.length === 0) {
                    return 0;
                }

                // Count consecutive successes from the end
                let count = 0;
                for (let i = currentLevelAttempts.length - 1; i >= 0; i--) {
                    if (currentLevelAttempts[i].result === 'success') {
                        count++;
                    } else {
                        break;
                    }
                }
                return count;
            };

            const [consecutiveSuccesses, setConsecutiveSuccesses] = useState(() =>
                calculateConsecutiveSuccesses(storage.getWorkout(workoutId))
            );

            useEffect(() => {
                if (workout && workout.type !== 'taskset') {
                    const currentDuration = workout.durationSteps[workout.currentLevel] || workout.durationSteps[workout.durationSteps.length - 1];
                    setTimeRemaining(currentDuration);
                    // Update consecutive successes when workout changes
                    setConsecutiveSuccesses(calculateConsecutiveSuccesses(workout));
                }
            }, [workout]);

            useEffect(() => {
                return () => {
                    if (intervalId) clearInterval(intervalId);
                };
            }, [intervalId]);

            const startTimer = () => {
                setTimerState('running');
                const currentDuration = workout.durationSteps[workout.currentLevel] || workout.durationSteps[workout.durationSteps.length - 1];
                setTimeRemaining(currentDuration);

                const id = setInterval(() => {
                    setTimeRemaining(prev => {
                        if (prev <= 1) {
                            clearInterval(id);
                            setTimerState('finished');
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                setIntervalId(id);
            };

            const recordTaskCompletion = (result) => {
                const updatedWorkout = { ...workout };
                const currentSet = updatedWorkout.taskSets[updatedWorkout.currentLevel];
                const currentTask = currentSet.tasks[updatedWorkout.currentTaskIndex];

                const attempt = {
                    level: updatedWorkout.currentLevel,
                    taskIndex: updatedWorkout.currentTaskIndex,
                    task: currentTask.task,
                    result,
                    completedAt: new Date().toISOString(),
                    timestamp: Date.now()
                };

                if (!updatedWorkout.attempts) {
                    updatedWorkout.attempts = [];
                }
                updatedWorkout.attempts.push(attempt);

                // For task sets: only success moves forward, failure stays on same task
                if (result === 'success') {
                    // Move to next task
                    updatedWorkout.currentTaskIndex += 1;

                    // Check if we completed all tasks in current set
                    if (updatedWorkout.currentTaskIndex >= currentSet.tasks.length) {
                        // Move to next set (level)
                        updatedWorkout.currentLevel = Math.min(
                            updatedWorkout.currentLevel + 1,
                            updatedWorkout.taskSets.length - 1
                        );
                        updatedWorkout.currentTaskIndex = 0;
                    }
                }
                // For failure, we stay on the same task (no reset, just try again)

                storage.updateWorkout(workoutId, updatedWorkout);
                setWorkout(updatedWorkout);
            };

            const recordResult = (result) => {
                // Stop the timer if it's running
                if (intervalId) {
                    clearInterval(intervalId);
                    setIntervalId(null);
                }

                const currentDuration = workout.durationSteps[workout.currentLevel] || workout.durationSteps[workout.durationSteps.length - 1];

                // Generate actual duration from normal distribution (mean = duration, sigma = 10% of duration)
                const sigma = currentDuration * 0.1;
                const actualDuration = normalRandom(currentDuration, sigma);

                const attempt = {
                    targetDuration: currentDuration,
                    actualDuration: actualDuration,
                    duration: currentDuration, // Keep for backward compatibility
                    level: workout.currentLevel,
                    result,
                    completedAt: new Date().toISOString(),
                    timestamp: Date.now()
                };

                const updatedWorkout = { ...workout };
                if (!updatedWorkout.attempts) {
                    updatedWorkout.attempts = [];
                }
                updatedWorkout.attempts.push(attempt);

                let newConsecutiveSuccesses = consecutiveSuccesses;

                // Update level based on result
                if (result === 'success') {
                    newConsecutiveSuccesses += 1;
                    setConsecutiveSuccesses(newConsecutiveSuccesses);

                    if (newConsecutiveSuccesses >= updatedWorkout.requiredSuccesses) {
                        // Level up!
                        updatedWorkout.currentLevel = Math.min(
                            updatedWorkout.currentLevel + 1,
                            updatedWorkout.durationSteps.length - 1
                        );
                        // Calculate required successes for the new level
                        const newLevelDuration = updatedWorkout.durationSteps[updatedWorkout.currentLevel];
                        updatedWorkout.requiredSuccesses = getRequiredSuccesses(newLevelDuration);
                        setConsecutiveSuccesses(0);
                        newConsecutiveSuccesses = 0;
                    }
                } else if (result === 'critical') {
                    // Level down on critical failure
                    updatedWorkout.currentLevel = Math.max(
                        updatedWorkout.currentLevel - 1,
                        0
                    );
                    // Recalculate required successes for the new level
                    const newLevelDuration = updatedWorkout.durationSteps[updatedWorkout.currentLevel];
                    updatedWorkout.requiredSuccesses = getRequiredSuccesses(newLevelDuration);
                    setConsecutiveSuccesses(0);
                    newConsecutiveSuccesses = 0;
                } else if (result === 'failure') {
                    // Reset consecutive successes on regular failure
                    setConsecutiveSuccesses(0);
                    newConsecutiveSuccesses = 0;
                }

                storage.updateWorkout(workoutId, updatedWorkout);
                setWorkout(updatedWorkout);
                setTimerState('ready');

                const newDuration = updatedWorkout.durationSteps[updatedWorkout.currentLevel] || updatedWorkout.durationSteps[updatedWorkout.durationSteps.length - 1];
                setTimeRemaining(newDuration);
            };

            // Handle missing workout
            if (!workout) {
                return (
                    <div className="max-w-2xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <p className="text-red-600">Workout not found</p>
                            <button
                                onClick={() => navigate('main')}
                                className="mt-4 text-blue-600 font-semibold"
                            >
                                ‚Üê Back to Main
                            </button>
                        </div>
                    </div>
                );
            }

            // Get current task info for task-set workouts
            let currentTask = null;
            let currentSet = null;
            let totalTasksInSet = 0;
            if (isTaskSetWorkout && workout.taskSets && workout.taskSets[workout.currentLevel]) {
                currentSet = workout.taskSets[workout.currentLevel];
                totalTasksInSet = currentSet.tasks.length;
                currentTask = currentSet.tasks[workout.currentTaskIndex] || null;
            }

            const currentDuration = !isTaskSetWorkout
                ? (workout.durationSteps[workout.currentLevel] || workout.durationSteps[workout.durationSteps.length - 1])
                : 0;

            // Render task-set workout UI
            if (isTaskSetWorkout) {
                const hasTimer = currentTask && currentTask.duration;

                return (
                    <div className="max-w-2xl mx-auto p-4">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center">
                                    <button
                                        onClick={() => navigate('main')}
                                        className="text-blue-600 font-semibold mr-4"
                                    >
                                        ‚Üê Back
                                    </button>
                                    <h1 className="text-2xl font-bold text-gray-800">{workout.name}</h1>
                                </div>
                                <button
                                    onClick={() => navigate('workout', workoutId)}
                                    className="text-blue-600 font-semibold text-sm"
                                >
                                    View Details
                                </button>
                            </div>

                            <div className="bg-green-50 p-6 rounded-lg mb-6">
                                <div className="flex justify-between items-center mb-3">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Current Set</p>
                                        <p className="text-4xl font-bold text-green-600">{workout.currentLevel + 1}/{workout.totalLevels}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-gray-600 mb-1">Task Progress</p>
                                        <p className="text-4xl font-bold text-blue-600">{workout.currentTaskIndex + 1}/{totalTasksInSet}</p>
                                    </div>
                                </div>
                            </div>

                            {currentTask && (
                                <div className="mb-6">
                                    <div className="bg-blue-50 p-6 rounded-lg mb-4">
                                        <h3 className="text-sm font-semibold text-gray-600 mb-2">Current Task:</h3>
                                        <p className="text-xl font-semibold text-gray-800 mb-3">{currentTask.task}</p>
                                        {currentTask.note && (
                                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-3">
                                                <p className="text-sm text-gray-700"><span className="font-semibold">Note:</span> {currentTask.note}</p>
                                            </div>
                                        )}
                                    </div>

                                    {hasTimer && (
                                        <div className="mb-4">
                                            <div className={`text-center py-12 rounded-lg mb-4 ${
                                                timerState === 'running' ? 'bg-green-100' :
                                                timerState === 'finished' ? 'bg-yellow-100' : 'bg-gray-100'
                                            }`}>
                                                <p className="text-6xl font-bold text-gray-800">{timeRemaining}s</p>
                                                <p className="text-sm text-gray-600 mt-2">Target: {currentTask.duration}s</p>
                                            </div>

                                            {timerState === 'ready' && (
                                                <button
                                                    onClick={() => {
                                                        setTimerState('running');
                                                        setTimeRemaining(currentTask.duration);
                                                        const id = setInterval(() => {
                                                            setTimeRemaining(prev => {
                                                                if (prev <= 1) {
                                                                    clearInterval(id);
                                                                    setTimerState('finished');
                                                                    return 0;
                                                                }
                                                                return prev - 1;
                                                            });
                                                        }, 1000);
                                                        setIntervalId(id);
                                                    }}
                                                    className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition"
                                                >
                                                    Start Timer
                                                </button>
                                            )}
                                        </div>
                                    )}

                                    <div className="space-y-2">
                                        <p className="text-center font-semibold text-gray-700 mb-3">
                                            {hasTimer && timerState === 'ready' ? 'Or record result without timer:' : 'Did your dog complete this task?'}
                                        </p>
                                        <button
                                            onClick={() => {
                                                if (intervalId) {
                                                    clearInterval(intervalId);
                                                    setIntervalId(null);
                                                }
                                                setTimerState('ready');
                                                recordTaskCompletion('success');
                                            }}
                                            className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-green-700 transition"
                                        >
                                            ‚úì Success - Next Task
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (intervalId) {
                                                    clearInterval(intervalId);
                                                    setIntervalId(null);
                                                }
                                                setTimerState('ready');
                                                recordTaskCompletion('failure');
                                            }}
                                            className="w-full bg-yellow-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-yellow-700 transition"
                                        >
                                            ~ Try Again
                                        </button>
                                    </div>
                                </div>
                            )}

                            {!currentTask && (
                                <div className="bg-green-100 p-8 rounded-lg text-center">
                                    <h2 className="text-2xl font-bold text-green-800 mb-2">Congratulations!</h2>
                                    <p className="text-gray-700">You've completed all tasks in this workout!</p>
                                </div>
                            )}

                            {workout.attempts && workout.attempts.length > 0 && (
                                <div className="bg-gray-50 p-4 rounded-lg mb-6">
                                    <h3 className="font-semibold text-gray-800 mb-3">Recent Attempts</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {workout.attempts.slice(-10).reverse().map((attempt, index) => {
                                            const attemptDate = new Date(attempt.completedAt);
                                            const tooltipText = `${attemptDate.toLocaleDateString()} ${attemptDate.toLocaleTimeString()}\nSet ${attempt.level + 1}, Task ${attempt.taskIndex + 1}`;

                                            return (
                                                <span
                                                    key={index}
                                                    className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                        attempt.result === 'success' ? 'bg-green-200 text-green-800' :
                                                        'bg-yellow-200 text-yellow-800'
                                                    }`}
                                                    title={tooltipText}
                                                >
                                                    {attempt.result === 'success' ? '‚úì' : '~'}
                                                </span>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Render duration-based workout UI
            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center">
                                <button
                                    onClick={() => navigate('main')}
                                    className="text-blue-600 font-semibold mr-4"
                                >
                                    ‚Üê Back
                                </button>
                                <h1 className="text-2xl font-bold text-gray-800">{workout.name}</h1>
                            </div>
                            <button
                                onClick={() => navigate('workout', workoutId)}
                                className="text-blue-600 font-semibold text-sm"
                            >
                                View Details
                            </button>
                        </div>

                        <div className="bg-blue-50 p-6 rounded-lg mb-6">
                            <div className="flex justify-between items-center mb-3">
                                <div>
                                    <p className="text-sm text-gray-600 mb-1">Current Level</p>
                                    <p className="text-4xl font-bold text-blue-600">{workout.currentLevel + 1}/{workout.totalLevels}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm text-gray-600 mb-1">Duration</p>
                                    <p className="text-4xl font-bold text-green-600">{currentDuration}s</p>
                                </div>
                            </div>
                            <div className="bg-white bg-opacity-50 p-3 rounded">
                                <p className="text-sm text-gray-700">
                                    Consecutive Successes: <span className="font-semibold text-green-700">{consecutiveSuccesses}/{workout.requiredSuccesses}</span>
                                </p>
                            </div>
                        </div>

                        <div className="mb-6">
                            <div className={`text-center py-12 rounded-lg mb-4 ${
                                timerState === 'running' ? 'bg-green-100' : 
                                timerState === 'finished' ? 'bg-yellow-100' : 'bg-gray-100'
                            }`}>
                                <p className="text-6xl font-bold text-gray-800">{timeRemaining}s</p>
                            </div>

                            {timerState === 'ready' && (
                                <button
                                    onClick={startTimer}
                                    className="w-full bg-green-600 text-white py-4 rounded-lg font-semibold shadow-md hover:bg-green-700 transition"
                                >
                                    Start Attempt
                                </button>
                            )}

                            {(timerState === 'running' || timerState === 'finished') && (
                                <div className="space-y-2">
                                    <p className="text-center font-semibold text-gray-700 mb-3">
                                        {timerState === 'running' ? 'Timer running - record result anytime:' : 'How did your dog do?'}
                                    </p>
                                    <button
                                        onClick={() => recordResult('success')}
                                        className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-green-700 transition"
                                    >
                                        ‚úì Success
                                    </button>
                                    <button
                                        onClick={() => recordResult('failure')}
                                        className="w-full bg-yellow-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-yellow-700 transition"
                                    >
                                        ~ Failure (resets progress)
                                    </button>
                                    <button
                                        onClick={() => recordResult('critical')}
                                        className="w-full bg-red-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-red-700 transition"
                                    >
                                        ‚úó Critical Failure (level down)
                                    </button>
                                </div>
                            )}
                        </div>

                        {workout.attempts && workout.attempts.length > 0 && (
                            <div className="bg-gray-50 p-4 rounded-lg mb-6">
                                <h3 className="font-semibold text-gray-800 mb-3">Recent Attempts</h3>
                                <div className="flex flex-wrap gap-2">
                                    {workout.attempts.slice(-10).reverse().map((attempt, index) => {
                                        const attemptDate = new Date(attempt.completedAt);
                                        const tooltipText = `${attemptDate.toLocaleDateString()} ${attemptDate.toLocaleTimeString()}\nLevel ${attempt.level + 1}\nTarget: ${attempt.duration}s${attempt.actualDuration ? `\nActual: ${attempt.actualDuration}s` : ''}`;

                                        return (
                                            <span
                                                key={index}
                                                className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                    attempt.result === 'success' ? 'bg-green-200 text-green-800' :
                                                    attempt.result === 'failure' ? 'bg-yellow-200 text-yellow-800' :
                                                    'bg-red-200 text-red-800'
                                                }`}
                                                title={tooltipText}
                                            >
                                                {attempt.result === 'success' ? '‚úì' : attempt.result === 'failure' ? '~' : '‚úó'}
                                            </span>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Service Worker Registration (disabled for local file:// testing)
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
